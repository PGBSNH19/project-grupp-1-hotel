name: Continous Integration

on:
  push:
    branches: [ development ]
  pull_request:
    branches: [ development ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: '5.0'
    - name: Install dependencies
      run: dotnet restore
    - name: Build
      run: dotnet build --configuration Release --no-restore
    - name: Test
      run: dotnet test --no-restore --verbosity normal
    # build and push Client image
    - name: ACR build Client
      id: acrclient
      uses: ams0/acr-task-github-action@v1
      with:
        service_principal: ${{ secrets.SERVICE_PRINCIPAL_ID }}
        service_principal_password: ${{ secrets.SERVICE_PRINCIPAL_PASSWORD }}
        tenant: ${{ secrets.TENANT }}
        registry: ${{ secrets.REGISTRY }}
        repository: ${{ secrets.CLIENT_REPOSITORY }}
        image: client
        # git_access_token: ${{ secrets.git_access_token }}
        folder: Hotel.Client/
        dockerfile: Dockerfile
    # build and push Server image
    - name: ACR build Server
      id: acrserver
      uses: ams0/acr-task-github-action@v1
      with:
        service_principal: ${{ secrets.SERVICE_PRINCIPAL_ID }}
        service_principal_password: ${{ secrets.SERVICE_PRINCIPAL_PASSWORD }}
        tenant: ${{ secrets.TENANT }}
        registry: ${{ secrets.REGISTRY }}
        repository: ${{ secrets.SERVER_REPOSITORY }}
        image: server
        # git_access_token: ${{ secrets.git_access_token }}
        folder: Hotel.Server/
        dockerfile: Dockerfile
